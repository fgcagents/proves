<!DOCTYPE html>
<html>
<head>
    <title>Mapa FGC en Tiempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([41.3879, 2.16992], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let marcadores = {};

        async function obtenerDatos() {
            const limitePorPagina = 20;
            let start = 0;
            let tieneMasDatos = true;

            while (tieneMasDatos) {
                try {
                    const url = `https://fgc.opendatasoft.com/api/explore/v2.1/catalog/datasets/posicionament-dels-trens/records?limit=${limitePorPagina}&start=${start}`;
                    const respuesta = await fetch(url);
                    const datos = await respuesta.json();

                    if (datos.results.length === 0) {
                        tieneMasDatos = false;
                    } else {
                        datos.results.forEach(tren => {
                            const lat = tren.geo_point_2d.lat;
                            const lon = tren.geo_point_2d.lon;
                            const unitat = tren.tipus_unitat;
                            const linia = tren.lin;
                            const puntual = tren.en_hora;
                            const desti = tren.desti;
                            const id = tren.id; // Asumiendo que cada tren tiene un ID único

                            const propera_parada = (() => {
                                try {
                                    if (!tren.properes_parades) return "N/A";
                                    const primeraParada = JSON.parse(tren.properes_parades.split(';')[0]);
                                    return primeraParada.parada || "N/A";
                                } catch (error) {
                                    return "N/A";
                                }
                            })();

                            if (marcadores[id]) {
                                // Actualizar la posición del marcador existente
                                marcadores[id].setLatLng([lat, lon]);
                                marcadores[id].setPopupContent(`<b>Unitat: </b>${unitat}<br><b>Línea: </b>${linia}<br><b>Puntual: </b>${puntual}<br><b>Destí: </b>${desti}<br><b>Propera: </b>${propera_parada}<br>`);
                            } else {
                                // Crear un nuevo marcador
                                const marcador = L.marker([lat, lon])
                                    .addTo(map)
                                    .bindPopup(`<b>Unitat: </b>${unitat}<br><b>Línea: </b>${linia}<br><b>Puntual: </b>${puntual}<br><b>Destí: </b>${desti}<br><b>Propera: </b>${propera_parada}<br>`);
                                marcadores[id] = marcador;
                            }
                        });
                        start += limitePorPagina;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    tieneMasDatos = false;
                }
            }
        }

        // Actualizar la página cada 15 segundos
        setInterval(() => {
            obtenerDatos();
        }, 5000);

        // Cargar datos iniciales
        obtenerDatos();
    </script>
</body>
</html>